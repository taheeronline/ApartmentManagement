@page "/apartment-quickgrid"
@rendermode InteractiveServer
@using System
@using System.Linq
@using ApartmentManagement.Application.DTOs
@using Microsoft.AspNetCore.Components.QuickGrid
@using Microsoft.AspNetCore.Components.Web
@inject ApartmentManagement.Application.Services.ApartmentService ApartmentService

<PageTitle>Apartment Quick Grid</PageTitle>
<h3>Apartment Quick Grid</h3>
<style>
    /* Fix table layout and prevent Name column from expanding. */
    .table-fixed { table-layout: fixed; }

    .table-fixed th:nth-child(2),
    .table-fixed td:nth-child(2) {
        max-width: 280px;
        width: 280px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .table-fixed td div.cell-ellipsis { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
</style>
@if (!string.IsNullOrWhiteSpace(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @errorMessage
        <button type="button" class="btn-close" @onclick="ClearMessages"></button>
    </div>
}

@if (!string.IsNullOrWhiteSpace(successMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @successMessage
        <button type="button" class="btn-close" @onclick="ClearMessages"></button>
    </div>
}
<div class="container">
    <div class="row">
        <div class="card">
            <div class="card-header">
                <EditForm Model="apartmentEdit" OnValidSubmit="SaveApartmentAsync" Enhance>
                    <div class="hstack gap-2">
                        <label class="col-form-label">Name</label>
                        <InputText class="form-control" @bind-Value="apartmentEdit.Name" maxlength="70" />
                        <label class="col-form-label">Address</label>
                        <InputText class="form-control" @bind-Value="apartmentEdit.Address" />

                        <button type="submit" class="btn btn-primary">@SaveMode</button>
                        <button type="button" class="btn btn-secondary" @onclick="CancelEdit">Cancel</button>
                    </div>
                </EditForm>
            </div>
            <div class="card-body">
                <QuickGrid Class="table table-striped table-fixed" Items="apartments" Pagination="paginationState">
                    <PropertyColumn Property="a => a.Id" Title="ID" Class="d-none" />
                    <PropertyColumn Property="a => a.Name" Title="Name" Sortable="true" IsDefaultSortColumn>
                        <ColumnOptions>
                            <input type="search" class="form-control" placeholder="Filter by name"
                                   @bind="nameFilter" @onkeyup="HandleSearchKeyUp" />
                        </ColumnOptions>
                    </PropertyColumn>
                    <PropertyColumn Property="a => a.Address" Title="Address" Sortable="true" />
                    <PropertyColumn Property="a => a.FlatCount" Title="Flats" Sortable="true" />

                    <TemplateColumn Title="Actions">
                        <button class="btn btn-danger" @onclick="@(() => DeleteApartmentAsync(context.Id))">Delete</button>
                        <button class="btn btn-info" @onclick="@(() => EditApartment(context))">Edit</button>
                    </TemplateColumn>
                </QuickGrid>
            </div>
            <div class="card-footer">
                <Paginator State="paginationState" />
            </div>
        </div>
    </div>
</div>

@code {
    PaginationState paginationState = new() { ItemsPerPage = 5 };
    IQueryable<ApartmentDto> apartments = Array.Empty<ApartmentDto>().AsQueryable();
    List<ApartmentDto> apartmentsList = new();

    ApartmentDto apartmentEdit { get; set; } = new();
    string SaveMode = "Add";
    string nameFilter = string.Empty;
    private string? errorMessage;
    private string? successMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadApartmentsAsync();
    }

    async Task LoadApartmentsAsync()
    {
        apartmentsList = (await ApartmentService.GetApartmentsAsync()).ToList();
        ApplyNameFilter(nameFilter);
    }

    async Task SaveApartmentAsync()
    {
        if (string.IsNullOrWhiteSpace(apartmentEdit.Name) || string.IsNullOrWhiteSpace(apartmentEdit.Address))
            return;

        ClearMessages();

        // Ensure name length limit
        if (!string.IsNullOrWhiteSpace(apartmentEdit.Name) && apartmentEdit.Name.Length > 70)
            apartmentEdit.Name = apartmentEdit.Name[..70];

        if (apartmentEdit.Id > 0)
        {
            try
            {
                await ApartmentService.UpdateApartmentAsync(apartmentEdit.Id, apartmentEdit.Name, apartmentEdit.Address);
                successMessage = "Apartment updated successfully.";
            }
            catch (ArgumentException ae)
            {
                errorMessage = ae.Message;
                return;
            }
            catch (InvalidOperationException ioe)
            {
                errorMessage = ioe.Message;
                return;
            }

            SaveMode = "Add";
        }
        else
        {
            try
            {
                await ApartmentService.AddApartmentAsync(apartmentEdit.Name, apartmentEdit.Address);
                successMessage = "Apartment added successfully.";
            }
            catch (ArgumentException ae)
            {
                errorMessage = ae.Message;
                return;
            }
            catch (InvalidOperationException ioe)
            {
                errorMessage = ioe.Message;
                return;
            }
        }

        apartmentEdit = new ApartmentDto();
        await LoadApartmentsAsync();
    }

    async Task DeleteApartmentAsync(int id)
    {
        if (id <= 0) return;

        ClearMessages();

        try
        {
            await ApartmentService.DeleteApartmentAsync(id);
            successMessage = "Apartment deleted successfully.";
            await LoadApartmentsAsync();
        }
        catch (ArgumentException ae)
        {
            errorMessage = ae.Message;
        }
        catch (InvalidOperationException ioe)
        {
            errorMessage = ioe.Message;
        }
    }

    void EditApartment(ApartmentDto apt)
    {
        apartmentEdit = new ApartmentDto
        {
            Id = apt.Id,
            Name = apt.Name,
            Address = apt.Address,
            FlatCount = apt.FlatCount
        };
        SaveMode = "Update";
    }

    void CancelEdit()
    {
        apartmentEdit = new ApartmentDto();
        SaveMode = "Add";
    }

    void HandleSearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") ApplyNameFilter(nameFilter);
    }

    void ApplyNameFilter(string pNameFilter)
    {
        if (!string.IsNullOrWhiteSpace(pNameFilter))
        {
            apartments = apartmentsList.Where(p => !string.IsNullOrWhiteSpace(p.Name) &&
                                                  p.Name.Contains(pNameFilter, StringComparison.OrdinalIgnoreCase))
                                       .AsQueryable();
        }
        else
        {
            apartments = apartmentsList.AsQueryable();
        }
    }

    void ClearMessages()
    {
        errorMessage = null;
        successMessage = null;
    }
}
